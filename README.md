# Инструмент уведомлений об оплате InSales

Веб-сервис и Telegram-бот для мониторинга оплаченных периодов аккаунтов InSales. Приложение ежедневно
проверяет дату `paid_till` для подключённых магазинов и за 7 дней до истечения срока отправляет напоминания
в Telegram. Управление ботом происходит через удобное меню с кнопками: можно просмотреть список аккаунтов,
даты оплат, добавить новый магазин или включить/выключить уведомления.

## Возможности

- Подключение нескольких аккаунтов InSales по API (домен, API key, пароль).
- Автоматическое обновление даты оплаты через официальное API.
- Ежедневные уведомления в Telegram за 7 дней до окончания оплаченного периода и в день окончания.
- Меню Telegram-бота для управления аккаунтами и уведомлениями.
- REST endpoint `/health` для проверки состояния сервиса.

## Требования

- Python 3.12+
- Аккаунт Telegram и токен бота (получить через [@BotFather](https://t.me/BotFather)).
- Доступ к API InSales (ключ и пароль) для каждого магазина.

## Настройка окружения

Скопируйте файл `.env` (пример ниже) и заполните значения:

```
TELEGRAM_BOT_TOKEN="<токен бота>"
DATABASE_URL="sqlite+aiosqlite:///./data/database.db"
NOTIFICATION_TIME="09:00"  # Необязательно, формат HH:MM
TIMEZONE="Europe/Moscow"   # Необязательно
```

> Значения `NOTIFICATION_TIME` и `TIMEZONE` опциональны. По умолчанию уведомления отправляются в 09:00 UTC.

## Локальный запуск

```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
uvicorn app.main:app --host 0.0.0.0 --port 8000
```

После запуска откройте Telegram и отправьте команду `/start` вашему боту, чтобы зарегистрировать чат и получить меню.

## Docker

Сервис готов к развёртыванию в контейнере на Ubuntu VPS. Соберите образ и запустите контейнер:

```bash
docker build -t insales-monitor .
docker run -d \
  --name insales-monitor \
  -p 8000:8000 \
  --env-file .env \
  -v $(pwd)/data:/app/data \
  insales-monitor
```

Том `data` используется для хранения базы SQLite с подключёнными аккаунтами и чатами Telegram.

## Структура проекта

```
app/
├── config.py            # Конфигурация и загрузка переменных окружения
├── database.py          # Настройки подключения к БД (SQLite по умолчанию)
├── main.py              # Точка входа FastAPI, инициализация бота и планировщика
├── models.py            # SQLAlchemy-модели аккаунтов и чатов
├── repositories.py      # Логика работы с БД
├── scheduler.py         # Планировщик ежедневных проверок (APScheduler)
├── services/
│   ├── insales.py       # Клиент для запросов к API InSales
│   └── notifier.py      # Проверка сроков и отправка уведомлений
└── telegram_bot/
    └── bot.py           # Хендлеры Telegram-бота и меню
```

## Тестирование

На данный момент автоматические тесты отсутствуют. Рекомендуется протестировать сценарии вручную:
1. Запустить приложение.
2. Подключить Telegram-бота командой `/start`.
3. Добавить аккаунт через меню и убедиться, что дата оплаты загружается.
4. Изменить дату оплаты в InSales и проверить, что напоминания приходят согласно графику.

## Дополнительные настройки

- При необходимости можно заменить SQLite на другую СУБД, указав собственный `DATABASE_URL`.
- Планировщик использует часовой пояс из `TIMEZONE`; указывайте имя из базы IANA (например, `Europe/Moscow`).
